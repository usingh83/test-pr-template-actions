name: PR Maintainer Bot
on:
  pull_request_target:
    types: [opened, edited, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  inject-questionnaires:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Inject questionnaires into PR description
        uses: actions/github-script@v6
        with:
          script: |
            async ({ github, context, core }) => {
              // Only run injection on PR creation
              if (context.payload.action !== 'opened') {
                core.info('Not an opened PR event; skipping questionnaire injection.');
                return;
              }

              const owner = context.repo.owner;
              const repo = context.repo.repo;
              const pr = context.payload.pull_request;
              if (!pr || !pr.number) {
                core.setFailed('No pull_request in context.');
                return;
              }
              const prNumber = pr.number;

              const markerStart = '<!-- QUESTIONNAIRES-START -->';
              const markerEnd = '<!-- QUESTIONNAIRES-END -->';
              const placeholder = '<!-- Maintainer-only fields will be added automatically -->';

              const parQuestionnaire = [
                '### PAR Approval Checklist',
                '- [ ] Is this change covered by an existing PAR?',
                '- [ ] If not, has a new PAR been filed and approved?',
                '- [ ] Approver login: _\\<approver login\\>_',
                ''
              ].join('\n');

              const bypassQuestionnaire = [
                '### Bypass PAR Approval Questionnaire',
                '- [ ] Explain why a PAR approval should be bypassed for this PR.',
                '- [ ] Risk assessment and mitigation steps:',
                ''
              ].join('\n');

              const questionnaireBlock = [
                markerStart,
                '**Automated questionnaires (added by bot)**',
                '',
                parQuestionnaire,
                '---',
                bypassQuestionnaire,
                '',
                markerEnd,
                ''
              ].join('\n');

              // Fetch latest PR body
              const { data: prData } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: prNumber
              });
              let body = prData.body || '';

              // If questionnaires already present, skip
              if (body.includes(markerStart)) {
                core.info('Questionnaires already present in PR body; skipping.');
                return;
              }

              // Insert at placeholder if present, otherwise append
              let newBody;
              if (body.includes(placeholder)) {
                newBody = body.replace(placeholder, `${placeholder}\n\n${questionnaireBlock}`);
              } else {
                newBody = `${body}\n\n${questionnaireBlock}`;
              }

              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: prNumber,
                body: newBody
              });

              core.info('Injected questionnaires into PR description as checkboxes.');
            }