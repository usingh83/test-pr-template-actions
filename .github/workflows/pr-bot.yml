name: PR Maintainer Bot
on:
  pull_request_target:
    types: [opened, edited, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  update-and-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Inject and maintain questionnaires / update maintainer fields
        uses: actions/github-script@v6
        with:
          script: |
            (async ({ github, context, core }) => {
              const owner = context.repo.owner;
              const repo = context.repo.repo;

              // Resolve PR number for PR events
              const prPayload = context.payload.pull_request || (context.payload.issue && context.payload.issue.pull_request && context.payload.issue);
              if (!prPayload || !prPayload.number) {
                core.info('No pull request in context; skipping.');
                return;
              }
              const prNumber = prPayload.number;
              const actor = context.actor;

              // Optional approvers list
              let approvers = [];
              try {
                const resp = await github.rest.repos.getContent({
                  owner,
                  repo,
                  path: '.github/PAR_APPROVERS',
                  ref: prPayload.base && prPayload.base.ref
                });
                const content = Buffer.from(resp.data.content, 'base64').toString();
                approvers = content.split('\n').map(s => s.trim()).filter(Boolean);
              } catch (e) {
                core.info('.github/PAR_APPROVERS not found or unreadable; treating as empty list.');
              }

              // Markers
              const maintainerStart = '<!-- MAINTAINER-FIELDS-START -->';
              const maintainerEnd = '<!-- MAINTAINER-FIELDS-END -->';
              const questionnairesStart = '<!-- QUESTIONNAIRES-START -->';
              const questionnairesEnd = '<!-- QUESTIONNAIRES-END -->';
              const placeholder = '<!-- Maintainer-only fields will be added automatically -->';

              // Questionnaire content (checkbox style)
              const parQuestionnaire = [
                '### PAR Approval Checklist',
                '- [ ] RMC attestation',
                '- [ ] ADA attestation',
                '- [ ] intent attestation',
                ''
              ].join('\n');

              const bypassQuestionnaire = [
                '### Bypass PAR Approval Questionnaire',
                '- [ ] Hotfix - urgent',
                '- [ ] Low-risk change',
                '- [ ] Approver judgment',
                '- [ ] Business requirement',
                ''
              ].join('\n');

              const questionnaireBlock = [
                questionnairesStart,
                '**Automated questionnaires (added by bot)**',
                '',
                parQuestionnaire,
                '---',
                bypassQuestionnaire,
                questionnairesEnd,
                ''
              ].join('\n');

              // Helper: escape regex special chars
              const esc = str => str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

              // Fetch latest PR body
              const { data: prData } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: prNumber
              });
              let body = prData.body || '';

              // Precompute questionnaire block regex for reuse
              const qStartEsc = esc(questionnairesStart);
              const qEndEsc = esc(questionnairesEnd);
              const qBlockRegex = new RegExp(`${qStartEsc}[\\s\\S]*?${qEndEsc}\\n?`, 'i');

              // If this is a new commit (synchronize), reset PAR approval and remove maintainer block
              if (context.payload.action === 'synchronize') {
                let newBody = body;

                // Remove maintainer block if present
                const mStartEsc = esc(maintainerStart);
                const mEndEsc = esc(maintainerEnd);
                const maintRegex = new RegExp(`${mStartEsc}[\\s\\S]*?${mEndEsc}\\n?`, 'g');
                newBody = newBody.replace(maintRegex, '');

                // Try to find existing questionnaire block and reset PAR checkboxes
                const qMatch = newBody.match(qBlockRegex);
                if (qMatch) {
                  let qBlock = qMatch[0];
                  // Use the same working regex to find the PAR section
                  const parSectionMatch = qBlock.match(/### PAR Approval Checklist[\s\S]*?(?=(\n---|\n\n|$))/i);
                  if (parSectionMatch) {
                    const parSection = parSectionMatch[0];
                    // Reset any checked box to unchecked
                    const parReset = parSection.replace(/- \[[ xX]\]/g, '- [ ]');
                    qBlock = qBlock.replace(parSection, parReset);
                    newBody = newBody.replace(qBlockRegex, qBlock);
                  }
                } else {
                  // If questionnaires were previously removed (e.g. after approval), re-insert them into the updated body
                  if (!newBody.includes(questionnairesStart)) {
                    if (newBody.includes(placeholder)) {
                      newBody = newBody.replace(placeholder, `${placeholder}\n\n${questionnaireBlock}`);
                  } else {
                    newBody = `${newBody}\n\n${questionnaireBlock}`;
                  }
                }
              }

              // Update only when something changed
              if (newBody !== body) {
                await github.rest.pulls.update({
                  owner,
                  repo,
                  pull_number: prNumber,
                  body: newBody
                });
                core.info('New commit detected: removed maintainer block, reset PAR checkboxes and ensured questionnaires are present.');
              } else {
                core.info('New commit detected but no maintainer block or PAR checkboxes to reset.');
              }
              return;
            }

              // Ensure questionnaires exist (inject on opened or if missing)
              if (!body.includes(questionnairesStart) && !body.includes(maintainerStart)) {
                if (context.payload.action === 'opened' || context.payload.action === 'reopened' || context.payload.action === 'edited') {
                  if (body.includes(placeholder)) {
                    body = body.replace(placeholder, `${placeholder}\n\n${questionnaireBlock}`);
                  } else {
                    body = `${body}\n\n${questionnaireBlock}`;
                  }
                  await github.rest.pulls.update({
                    owner,
                    repo,
                    pull_number: prNumber,
                    body
                  });
                  core.info('Injected questionnaires into PR body (no maintainer block present).');
                } else {
                  core.info('Questionnaires missing but not an insertion-trigger event; skipping injection.');
                }
              } else if (body.includes(questionnairesStart) && body.includes(maintainerStart)) {
                // Safety: if both exist, prefer maintainer block and remove questionnaires
                body = body.replace(qBlockRegex, '');
                await github.rest.pulls.update({ owner, repo, pull_number: prNumber, body });
                core.info('Both maintainer and questionnaires were present; removed questionnaires to enforce mutual exclusion.');
              } else {
                core.info('Questionnaires already present or maintainer block present; skipping insertion.');
              }

              // Refresh PR body after possible injection
              const { data: refreshed } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: prNumber
              });
              let refreshedBody = refreshed.body || '';

              // Extract questionnaire block (if any)
              const qBlockMatch = refreshedBody.match(qBlockRegex);
              if (!qBlockMatch) {
                core.info('No questionnaire block present; nothing to evaluate.');
                return;
              }
              const qBlock = qBlockMatch[0];

              // Find PAR Approval Checklist section within questionnaire block
              const parSectionMatch = qBlock.match(/### PAR Approval Checklist[\s\S]*?(?=(\n---|\n\n|$))/i);
              if (!parSectionMatch) {
                core.info('No PAR Approval Checklist found inside questionnaires.');
                return;
              }
              const parSection = parSectionMatch[0];

              // Count checkboxes
              const checkboxRegex = /- \[([ xX])\]\s.*$/gm;
              let total = 0;
              let checked = 0;
              let m;
              while ((m = checkboxRegex.exec(parSection)) !== null) {
                total += 1;
                if (m[1].trim().toLowerCase() === 'x') checked += 1;
              }

              // If all checked, update maintainer fields and remove questionnaires
              if (total > 0 && checked === total) {
                const approvalDate = new Date().toISOString().split('T')[0];
                const approverDisplay = approvers.includes(actor) ? `@${actor}` : `@${actor}`;

                const maintainerBlock = [
                  maintainerStart,
                  '**Maintainer-only fields (added by bot)**',
                  '',
                  '- PAR required: _yes_',
                  `- Approver: _${approverDisplay}_`,
                  `- Approval date: _${approvalDate}_`,
                  '',
                  '_Please do not edit the above fields; they are managed by the bot._',
                  maintainerEnd,
                  ''
                ].join('\n');

                // Remove questionnaire block entirely
                refreshedBody = refreshedBody.replace(qBlockRegex, '');

                // Replace or insert maintainer block
                const mStartEsc2 = esc(maintainerStart);
                const mEndEsc2 = esc(maintainerEnd);
                const maintRegex2 = new RegExp(`${mStartEsc2}[\\s\\S]*?${mEndEsc2}`, 'g');
                if (maintRegex2.test(refreshedBody)) {
                  refreshedBody = refreshedBody.replace(maintRegex2, maintainerBlock.trim());
                } else if (refreshedBody.includes(placeholder)) {
                  refreshedBody = refreshedBody.replace(placeholder, `${placeholder}\n\n${maintainerBlock}`);
                } else {
                  refreshedBody = `${refreshedBody}\n\n${maintainerBlock}`;
                }

                await github.rest.pulls.update({
                  owner,
                  repo,
                  pull_number: prNumber,
                  body: refreshedBody
                });
                core.info('All PAR checklist items checked â€” maintainer fields updated and questionnaires removed.');
                return;
              }

              core.info(`PAR checklist not fully checked (${checked}/${total}). No maintainer update.`);
            })({ github, context, core });